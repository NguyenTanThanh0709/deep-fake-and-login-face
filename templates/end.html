{% extends 'layout.html' %}

{% block title %}Danh Sách Điểm Danh{% endblock %}

{% block content %}
        <!-- Main Content -->
        <div class="flex-1">
            <!-- Main Content Area --> 
            <div class="container-fluid mx-auto" id="contprofile">
                <div class="container text-center py-3">
                    <h1 class="text-2xl mb-3">BÁO CÁO CUỐI GIỜ</h1>
                    <h1 class="text-2xl mb-3">Chụp Hình hoặc Quay Video</h1>

                    <div class="mb-3">
                        <button id="startCamera" class="btn btn-primary btn-sm">Mở Camera</button>
                    </div>

                    <div class="flex flex-row items-start space-x-4 mb-3">
                        <!-- Video -->
                        <video id="video" class="w-1/3 h-auto border border-gray-300 rounded" autoplay></video>
                        
                        <!-- Canvas -->
                        <canvas id="canvas" class="w-1/3 h-auto d-none border border-gray-300 rounded"></canvas>
                        
                        <!-- Ảnh đã chụp -->
                        <div id="photoPreviewContainer" class="w-1/3 h-auto d-none">
                            <img id="photoPreview" class="w-full border border-gray-300 rounded" alt="Ảnh đã chụp">
                        </div>
                    </div>
                    

                    <div>
                        <button id="capturePhoto" class="btn btn-success btn-sm d-none">Chụp Hình</button>
                    </div>

                    <div class="mt-3">
                        <a id="downloadLink" class="btn btn-info btn-sm d-none" href="#" download>Download</a>
                    </div>

                    <div class="mt-3">
                        <a class="btn btn-info btn-sm d-none" id="saveLink_luu" href="#" download>Lưu</a>
                    </div>
                    <!-- Button for capturing photo or video -->
                    <div class="mt-3">
                        <a class="btn btn-info btn-sm d-none" id="saveLink" href="#" download>Báo cáo</a>
                    </div>


                </div>
            </div>
        </div>

    
    <script>
        var fileName = ""
        let videoStream;
        let countdownTimer;
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const startCameraButton = document.getElementById('startCamera');
        const capturePhotoButton = document.getElementById('capturePhoto');
        const downloadLink = document.getElementById('downloadLink');
        const countdownElement = document.getElementById('countdown');
        const saveLink = document.getElementById('saveLink');
        const saveLink_luu = document.getElementById('saveLink_luu');
        
        // Open the camera and display it on the video element
        startCameraButton.addEventListener('click', async () => {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = videoStream;
                videoElement.onloadedmetadata = () => {
                    // This ensures that the video metadata is loaded before you try to access its dimensions
                    capturePhotoButton.classList.remove('d-none');
                    startCameraButton.classList.add('d-none');
                };
            } catch (err) {
                console.error('Error accessing camera:', err);
            }
        });
        
        // Capture a photo
        capturePhotoButton.addEventListener('click', () => {
            const context = canvasElement.getContext('2d');
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            const photoData = canvasElement.toDataURL('image/jpeg');

                // Hiển thị ảnh đã chụp
            const photoPreviewContainer = document.getElementById('photoPreviewContainer');
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.src = photoData;
            photoPreviewContainer.classList.remove('d-none');
        
            // Download the captured photo
            downloadLink.href = photoData;
            // downloadLink.classList.remove('d-none');
            downloadLink.textContent = 'Download Photo';
        
            // Show the "Lưu Video" button
            // saveLink.classList.remove('d-none');
            saveLink_luu.classList.remove('d-none');
        });
        

        
 
            saveLink.addEventListener('click', () => {
            const employee = localStorage.getItem('employee');
            if (employee) {

                let fileData;
                let fileBlob;
                var sdt = JSON.parse(employee).sdt;
            
                if (downloadLink.textContent === "Download Photo") {
                    const photoData = canvasElement.toDataURL('image/jpeg');
                    const byteString = atob(photoData.split(',')[1]); // Decode base64 data
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    const blob = new Blob([ab], { type: 'image/jpeg' });
            
                    const formData = new FormData();
                    formData.append('image', blob, 'photo.jpg');
                    formData.append('fileType', 'image');
                    formData.append('sdt', sdt);fileName
                    formData.append('filePath', fileName);
            
                    // Send the formData to Flask
                    fetch('/attendance/end', { method: 'POST', body: formData })
                        .then(response => response.json())
                        .then(data => {
                            if(data.status == "NOT"){
                                alert("Hình Bị Lỗi vui lòng chụp lại");
                            }
                            if(data.status == "OK"){
                                alert("Đã Báo cáo");
                                if(data.message == "SUCCESS"){
                                    alert("Báo cáo thành công");
                                }else{
                                    alert("Báo cáo thất bại! vui lòng thử lại");
                                }
                                window.location.href = "/";
                            }
                            console.log('File saved successfully:', data);
                        })
                        .catch(error => {
                            console.error('Error saving file:', error);
                        });
            
                }
            }

        });

            saveLink_luu.addEventListener('click', () => {
                saveLink.classList.remove('d-none');
                saveLink_luu.classList.add('d-none');
                // Check if the data is an image or video and send it to the Flask backend
                let fileData;
                let fileBlob;

                if (downloadLink.textContent === "Download Photo") {
                    const photoData = canvasElement.toDataURL('image/jpeg');
                    const byteString = atob(photoData.split(',')[1]); // Decode base64 data
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    const blob = new Blob([ab], { type: 'image/jpeg' });
            
                    const formData = new FormData();
                    formData.append('file', blob, 'photo.jpg');
                    formData.append('fileType', 'image');
                    const employee = localStorage.getItem('employee');
                    var sdt = JSON.parse(employee).sdt;
                    formData.append('sdt', sdt);
            
                    // Send the formData to Flask
                    fetch('/save-media-start', { method: 'POST', body: formData })
                        .then(response => response.json())
                        .then(data => {
                            console.log('File saved successfully:', data);
                            fileName = data.file_path;
                        })
                        .catch(error => {
                            console.error('Error saving file:', error);
                        });
                }
            });        

            </script>
        
            <!-- Bootstrap JS -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
{% endblock %}
